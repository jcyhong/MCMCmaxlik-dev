---
title: "stochVolatilityExample"
author: "Sara Stoudt"
date: "September 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("MCMCmaxlik")
```

```{r}
phi=.2
mu=10
sigmaEta=3
h=rep(0,50)
etat=1
ut=.25
y=rep(ut*exp(0/2),50)
for(i in 2:50){
  h[i]=mu+phi*(h[i-1]-mu)+etat
  y[i]=ut*exp(h[i]/2)
}

 
```

```{r}
svCode <- nimbleCode({
 ut ~ dnorm(0,1)
 etat ~ dnorm(0,sd=sigmaEta)
  #h[1] <- 0
  y[1] <- ut*exp(h[1]/2)
  for (i in 2:T) {
    h[i] <- mu+phi*(h[i-1]-mu)+etat
    y[i] <- ut*exp(h[i]/2)
  }
  phi ~dunif(-.999,0.999)
  mu ~ dnorm(0, sd = 1000)
  sigmaEta~dunif(0, 1000)
})

Consts <- list(T = 50)

data <- list(
  h=h,
  y=y
)

inits <- list(phi=.5,mu=10,sigmaEta=5,ut=2)


## build the model object
svModel <- nimbleModel(svCode, constants = Consts,data=data,inits=inits)



## put values in the top-level parameters
# svModel$phi <- 0.5
# svModel$mu <- 2.0
# sigmaEta <- 2.0
# 
# ## calculate any dependencies that may be needed to simulate states and data
# svModel$calculate(svModel$getDependencies( c('phi','mu','sigmaEta'), determOnly = TRUE))
# 
# 
# ## use the model to simulate states and data
# set.seed(12345)
# svModel$simulate( svModel$getDependencies(c('h','y')))
# ## Look at what we got:
# svModel$h
# svModel$y
# svModel$setData('y')
## this wasn't working

paramNodesSV <- svModel$getNodeNames(topOnly=T)
CsvModel <- compileNimble(svModel)
```

```{r compile}
compiledFunsSVmodelel <- buildMCMCmaxlik(svModel, paramNodesSV)

```


# Testing Algorithms

```{r}
# 1. Fixed step size ----------------------------------------
# Compile the necesvary functions.

# need to make sure these are in the right order
#init <- c(0.75,10,2)
boundary <- list(c(-100, 100),c(-.9999,0.9999),c(-1000,1000),c(0,1000))
numMCMCSamples <- 300

ptm <- proc.time()
resultsSVModFixed <- computeMLE(svModel, paramNodesSV,
                               method="fixed", paramInit=init,
                               compiledFuns=compiledFunsSVmodelel,
                               stepsize=0.05,
                               numMCMCSamples=numMCMCSamples,
                               maxIter=500,
                               boundary=boundary)
timesSVModFixed <- proc.time() - ptm
timesSVModFixed  ## 21.330 
mean(tail(resultsSVModFixed$param[, 1], 20), trim=.2)  ##  1.06675
mean(tail(resultsSVModFixed$param[, 2], 20), trim=.2)  ## 0.9999
mean(tail(resultsSVModFixed$param[, 3], 20), trim=.2)  ##  1.00063
mean(tail(resultsSVModFixed$param[, 3], 20), trim=.2)  ## 1.00063
save(resultsSVModFixed, file="svModFixed.RData")
```

```{r}
# 2. Small fixed step size ----------------------------------------
ptm <- proc.time()
resultsSVModSmallFixed <- computeMLE(svModel, paramNodesSV,
                                    method="fixed", paramInit=init,
                                    compiledFuns=compiledFunsSVmodel,
                                    stepsize=0.005,
                                    numMCMCSamples=numMCMCSamples,
                                    maxIter=5000,
                                    boundary=boundary)
timesSVModSmallFixed <- proc.time() - ptm ## 233.045 
timesSVModSmallFixed  
mean(tail(resultsSVModSmallFixed$param[, 1], 20), trim=.2)  ## 0.9090979
mean(tail(resultsSVModSmallFixed$param[, 2], 20), trim=.2) ## 0.9999
mean(tail(resultsSVModSmallFixed$param[, 3], 20), trim=.2)  ## 1.000064
mean(tail(resultsSVModSmallFixed$param[, 4], 20), trim=.2) ## 1000 

save(resultsSVModSmallFixed, file="svModSmallFixed.RData")
```

```{r}
# 3. Adadelta ----------------------------------------
ptm <- proc.time()
resultsSVModAdadelta <- computeMLE(svModel, paramNodesSV,
                                  method="adadelta", paramInit=init,
                                  compiledFuns=compiledFunsSVmodel,
                                  numMCMCSamples=numMCMCSamples,
                                  maxIter=300,
                                  boundary=boundary)
timesSVModAdadelta <- proc.time() - ptm
timesSVModAdadelta  ## 0.386 
mean(tail(resultsSVModAdadelta$param[, 1], 20), trim=.2)  ## 0.2459932
mean(tail(resultsSVModAdadelta$param[, 2], 20), trim=.2)  ## 0.9999
mean(tail(resultsSVModAdadelta$param[, 3], 20), trim=.2)  ## 0.2459932
mean(tail(resultsSVModAdadelta$param[, 4], 20), trim=.2)  ## 0.9987716
save(resultsSVModAdadelta, file="svModAdadelta.RData")

```

```{r}

# 4. Adam ----------------------------------------
ptm <- proc.time()
resultsSVModAdam <- computeMLE(svModel, paramNodesSV,
                              method="adam", paramInit=init,
                              compiledFuns=compiledFunsSVmodel,
                              numMCMCSamples=numMCMCSamples,
                              maxIter=300,
                              boundary=boundary)
timesSVModAdam <- proc.time() - ptm
timesSVModAdam  ## 0.150 
mean(tail(resultsSVModAdam$param[, 1], 20), trim=.2)  ## 1.234483
mean(tail(resultsSVModAdam$param[, 2], 20), trim=.2)  ## 0.9999
mean(tail(resultsSVModAdam$param[, 3], 20), trim=.2)  ## 1.075362
mean(tail(resultsSVModAdam$param[, 3], 20), trim=.2)  ## 1.075362
save(resultsSVModAdam, file="svModAdam.RData")

```

```{r}
# 5. Newton-Raphson ----------------------------------------
ptm <- proc.time()
resultsSVModNR <- computeMLE(svModel, paramNodes=paramNodesSV,
                            method="NR", paramInit=init,
                            compiledFuns=compiledFunsSVmodel,
                            numMCMCSamples=numMCMCSamples,
                            tol=1e-20,
                            maxIter=300,
                            boundary=boundary)
timesSVModNR <- proc.time() - ptm
timesSVModNR 
# warning: problem initializing stochastic node, logProb less than -1e12
# |-------------|-------------|-------------|-------------|
# |-------------------------------------------------------|
# [1] -0.3890967480  0.0000000000 -0.0001298736 -0.0453409685
# Error in if (thetaNew[i] < boundary[[i]][1]) { : 
#   missing value where TRUE/FALSE needed
mean(resultsSVModNR$param[201:300,1], trim=.2)
mean(resultsSVModNR$param[201:300,2], trim=.2) 
mean(resultsSVModNR$param[201:300,3], trim=.2)
mean(resultsSVModNR$param[201:300,4], trim=.2)
save(resultsSVModNR, file="svModNR.RData")
```

```{r}
# 6. 1-D sampling ----------------------------------------
ptm <- proc.time()
resultsSVMod1D <- computeMLE(svModel, paramNodesSV,
                            method="ga1D", paramInit=init,
                            compiledFuns=compiledFunsSVmodel,
                            numMCMCSamples=300, numMCMCSamples1D=300, 
                            maxIter=300)
timesSVMod1D <- proc.time() - ptm
timesSVMod1D  ## 1.884 
mean(tail(resultsSVMod1D$param[, 1], 20), trim=.2)  ## 0.1099437
mean(tail(resultsSVMod1D$param[, 2], 20), trim=.2)  ##  0.999
mean(tail(resultsSVMod1D$param[, 3], 20), trim=.2)  ## 1.077608
mean(tail(resultsSVMod1D$param[, 4], 20), trim=.2)  ## 999.9996
save(resultsSVMod1D, file="svMod1D.RData")

```


```{r}
# 7. Hybrid
# Run 10 iterations of 1D, and then run Adam.
ptm <- proc.time()
resultsSVMod1DFirst <- computeMLE(svModel, paramNodesSV,
                                 method="ga1D", paramInit=init,
                                 compiledFuns=compiledFunsSVmodel,
                                 numMCMCSamples=numMCMCSamples, 
                                 numMCMCSamples1D=300, 
                                 maxIter=10)
resultsSVModAdamSecond <- computeMLE(svModel, paramNodesSV,
                                    method="adam", 
                                    paramInit=tail(resultsSVMod1DFirst$param, 1),
                                    compiledFuns=compiledFunsSVmodel,
                                    numMCMCSamples=numMCMCSamples,
                                    maxIter=300,
                                    boundary=boundary)
timesSVModHybrid <- proc.time() - ptm
timesSVModHybrid ##  9.153 

mean(tail(resultsSVModAdamSecond$param[, 1], 20), trim=.2)  ## -9.993417
mean(tail(resultsSVModAdamSecond$param[, 2], 20), trim=.2)  ##  0.999
mean(tail(resultsSVModAdamSecond$param[, 3], 20), trim=.2)  ## -1.550725
mean(tail(resultsSVModAdamSecond$param[, 4], 20), trim=.2)  ## 6.777809

```

```{r}
# MCEM -----------------------------
#source("MCEM_with_output.R")
svMod2 <- svModel$newModel()

box <- list(list(c("ut",c(-100,100)),c('sigmaEta'), c(0, 1000)),list(c("phi"),c(-0.9999, 0.9999)),list(c("mu"),c(-Inf,Inf)))
svModMCEM <- buildMCEM(model=svMod2, latentNodes=list(svModel$getNodeNames(latentOnly=T)),
                      boxConstraints=box)
#NAs introduced by coercionError in modelDef$maps$graphID_2_nodeName[graphID] : 
#  only 0's may be mixed with negative subscripts

## specifying latent nodes wrong?
svModel$getNodeNames(latentOnly=T)

ptm <- proc.time()
resultsSVModMCEM <- svModMCEM$run(initM = 1000) 
timesSVModMCEM <- proc.time() - ptm
timesSVModMCEM 

# Save outputs ------------------------
save(resultsSVModMCEM, file="MCEM_svMod.RData")
```

```{r}
timeInfo <- cbind(c(timesSVModFixed, timesSVModSmallFixed,
                    timesSVModAdadelta, timesSVModAdam,
                    timesSVModNR, timesSVMod1D, timesSVModMCEM),
                  c("fixed", "smallFixed", "adadelta", "adam",
                    "NR", "1D", "mcem"))

write.csv(timeInfo, "timesSVMod.csv", row.names=F)

```