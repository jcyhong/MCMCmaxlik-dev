---
title: "stateSpaceModExample"
author: "Sara Stoudt"
date: "September 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("MCMCmaxlik")
```


```{r}
#ssModel$rho <- 0.5
#ssModel$mu <- 5.0
#ssModel$sigPN <- 5
#ssModel$sigOE <- 5

set.seed(931154)
rho=0.5
sigPN=5
sigOE=5
x0=5
TT=100
x=rep(rnorm(1,rho*x0,sd=sqrt(sigPN^2/(1-rho*rho))),TT)
y=rep(rnorm(1,x[1],sd=sigOE),TT)
for(i in 2:TT){
  x[i] =rnorm(1,rho * x[i - 1] , sd = sigPN)
    y[i] =rnorm(1,x[i], sd = sigOE)
}
```

```{r}
ssCode <- nimbleCode({
  rho ~ dunif(-0.9999, 0.9999)
  #mu ~ dnorm(0, sd = 1000) # 0
  sigPN ~ dunif(1e-04, 100)
  sigOE ~ dunif(1e-04, 100)
  x0 ~dnorm(0, sd = 1000)
  x[1] ~ dnorm(rho*x0, sd = sqrt(sigPN^2/(1-rho*rho)))
  #x[1] ~ dnorm(rho*x0, sd = sigPN)
  #x[1] ~ dnorm(mu, sd = sqrt(sigPN^2/(1-rho*rho)))
  y[1] ~ dnorm(x[1], sd = sigOE)
  for (i in 2:TT) {
    #x[i] ~ dnorm(rho * (x[i - 1] - mu) + mu, sd = sigPN)
    x[i] ~ dnorm(rho * x[i - 1] , sd = sigPN)
    y[i] ~ dnorm(x[i], sd = sigOE)
  }
}) ## take out mu

Consts <- list(TT = 100)

data <- list(
  x=x,
  y=y
)


## build the model object
ssModel <- nimbleModel(ssCode, constants = Consts,data=data)

## put values in the top-level parameters
#ssModel$rho <- 0.5
#ssModel$mu <- 5.0
#ssModel$sigPN <- 5
#ssModel$sigOE <- 5

## calculate any dependencies that may be needed to simulate states and data
#ssModel$calculate(ssModel$getDependencies( c('rho','sigPN','sigOE'), determOnly = TRUE))


## use the model to simulate states and data
#set.seed(12345)
#ssModel$simulate( ssModel$getDependencies(c('x','y')))
## Look at what we got:
#ssModel$x
#ssModel$y
#ssModel$setData('y')

write.csv(cbind(x,y),"statespaceModData.csv")

paramNodesSS <- ssModel$getNodeNames(topOnly=T)
CssModel <- compileNimble(ssModel)
```

```{r compile}
compiledFunsSSmodel <- buildMCMCmaxlik(ssModel, paramNodesSS)
```


# Testing Algorithms

```{r}
# 1. Fixed step size ----------------------------------------
# Compile the necessary functions.

init <- c(0.75,10,10,10)
boundary <- list(c(-0.9999, 0.9999),c(1e-04, 100),c(1e-04, 100),c(-100000,100000))
numMCMCSamples <- 300

ptm <- proc.time()
resultsSSModFixed <- computeMLE(ssModel, paramNodesSS,
                               method="fixed", paramInit=init,
                               compiledFuns=compiledFunsSSmodel,
                               stepsize=0.05,
                               numMCMCSamples=numMCMCSamples,
                               maxIter=300,
                               boundary=boundary)
timeSSModFixed <- proc.time() - ptm
timeSSModFixed  ## 76.654 
resultsSSModFixed$iter ## 300
mean(tail(resultsSSModFixed$param[, 1], 20), trim=.2)  # 0
mean(tail(resultsSSModFixed$param[, 2], 20), trim=.2)   # 89.20093
mean(tail(resultsSSModFixed$param[, 3], 20), trim=.2) #  6.82339
mean(tail(resultsSSModFixed$param[, 4], 20), trim=.2)  # -490.0202

save(resultsSSModFixed, file="SSModFixed.RData")
```

```{r}
# 2. Small fixed step size ----------------------------------------
ptm <- proc.time()
resultsSSModSmallFixed <- computeMLE(ssModel,paramNodesSS,
                                    method="fixed", paramInit=init,
                                    compiledFuns=compiledFunsSSmodel,
                                    stepsize=0.005,
                                    numMCMCSamples=numMCMCSamples,
                                    maxIter=3000,
                                    boundary=boundary)
timeSSModSmallFixed <- proc.time() - ptm
timeSSModSmallFixed  ##758.414 
resultsSSModSmallFixed$iter ## 3000
mean(tail(resultsSSModSmallFixed$param[, 1], 20), trim=.2)  ## 0.5643654
mean(tail(resultsSSModSmallFixed$param[, 2], 20), trim=.2) ## 5.848441
mean(tail(resultsSSModSmallFixed$param[, 3], 20), trim=.2)  ##  5.044582
mean(tail(resultsSSModSmallFixed$param[, 4], 20), trim=.2) ## 9.364259
save(resultsSSModSmallFixed, file="SSModSmallFixed.RData")
## Not too bad
```

```{r}
# 3. Adadelta ----------------------------------------
ptm <- proc.time()
resultsSSModAdadelta <- computeMLE(ssModel, paramNodesSS,
                                  method="adadelta", paramInit=init,
                                  compiledFuns=compiledFunsSSmodel,
                                  numMCMCSamples=numMCMCSamples,
                                  maxIter=300,
                                  boundary=boundary)
timeSSModAdadelta <- proc.time() - ptm
timeSSModAdadelta  ## 21.874 
resultsSSModAdadelta$iter ## 300
mean(tail(resultsSSModAdadelta$param[, 1], 20), trim=.2)  ##  0.4941772
mean(tail(resultsSSModAdadelta$param[, 2], 20), trim=.2)  ##5.397212
mean(tail(resultsSSModAdadelta$param[, 3], 20), trim=.2)  ## 5.881106
mean(tail(resultsSSModAdadelta$param[, 4], 20), trim=.2)  ## 4.171167
save(resultsSSModAdadelta, file="SSModAdadelta.RData")

```

```{r}

# 4. Adam ----------------------------------------
ptm <- proc.time()
resultsSSModAdam <- computeMLE(ssModel, paramNodesSS,
                              method="adam", paramInit=init,
                              compiledFuns=compiledFunsSSmodel,
                              numMCMCSamples=numMCMCSamples,
                            maxIter=300,
                              #maxIter=500,
                              boundary=boundary)
timeSSModAdam <- proc.time() - ptm
timeSSModAdam  ## 20.471 
resultsSSModAdam$iter ## 300
mean(tail(resultsSSModAdam$param[, 1], 20), trim=.2)  ## 0.544809
mean(tail(resultsSSModAdam$param[, 2], 20), trim=.2)  ## 6.10195
mean(tail(resultsSSModAdam$param[, 3], 20), trim=.2)  ## 4.759216
mean(tail(resultsSSModAdam$param[, 4], 20), trim=.2) ## -1.086024
save(resultsSSModAdam, file="SSModAdam.RData")

```

```{r}
# 5. Newton-Raphson ----------------------------------------
ptm <- proc.time()
resultsSSModNR <- computeMLE(ssModel, paramNodes=paramNodesSS,
                            method="NR", paramInit=init,
                            compiledFuns=compiledFunsSSmodel,
                            numMCMCSamples=numMCMCSamples,
                            tol=1e-20,
                            maxIter=300,
                            boundary=boundary)
timeSSModNR <- proc.time() - ptm
timeSSModNR  ## 43.207 
resultsSSModNR$iter # 300
mean(tail(resultsSSModNR$param[, 1], 20), trim=.2) ## -0.1333344
mean(tail(resultsSSModNR$param[, 2], 20), trim=.2)  ## 100
mean(tail(resultsSSModNR$param[, 3], 20), trim=.2) ##  86.87978
mean(tail(resultsSSModNR$param[, 4], 20), trim=.2)  ##  -256.4081
save(resultsSSModNR, file="SSModNR.RData")
```

```{r}
# 6. 1-D sampling ----------------------------------------
ptm <- proc.time()
resultsSSMod1D <- computeMLE(ssModel, paramNodesSS,
                            method="ga1D", paramInit=init,
                            compiledFuns=compiledFunsSSmodel,
                            numMCMCSamples=300, numMCMCSamples1D=300, 
                            maxIter=300)
timeSSMod1D <- proc.time() - ptm
timeSSMod1D  ##  83.689 
resultsSSMod1D$iter ## 300
mean(tail(resultsSSMod1D$param[, 1], 20), trim=.2)  ## 0.5398541 
mean(tail(resultsSSMod1D$param[, 2], 20), trim=.2)   ## 5.635582
mean(tail(resultsSSMod1D$param[, 3], 20), trim=.2) ## 5.262272
mean(tail(resultsSSMod1D$param[, 4], 20), trim=.2)  ##  9.966151
save(resultsSSMod1D, file="SSMod1D.RData")

```


```{r}
# 7. Hybrid
# Run 10 iterations of 1D, and then run Adam.
ptm <- proc.time()
resultsSSMod1DFirst <- computeMLE(ssModel, paramNodesSS,
                                 method="ga1D", paramInit=init,
                                 compiledFuns=compiledFunsSSmodel,
                                 numMCMCSamples=numMCMCSamples, 
                                 numMCMCSamples1D=300, 
                                 maxIter=10)
resultsSSModAdamSecond <- computeMLE(ssModel, paramNodesSS,
                                    method="adam", 
                                    paramInit=tail(resultsSSMod1DFirst$param, 1),
                                    compiledFuns=compiledFunsSSmodel,
                                    numMCMCSamples=numMCMCSamples,
                                    maxIter=300,
                                    boundary=boundary)
timeSSModHybrid <- proc.time() - ptm
timeSSModHybrid  ##  23.544 
resultsSSModAdamSecond$iter ## 300
mean(tail(resultsSSModAdamSecond$param[, 1], 20), trim=.2)   ## 0.445668
mean(tail(resultsSSModAdamSecond$param[, 2], 20), trim=.2)   ##  7.243499
mean(tail(resultsSSModAdamSecond$param[, 3], 20), trim=.2)   ## 3.187646
mean(tail(resultsSSModAdamSecond$param[, 4], 20), trim=.2)  ## -3.627633

```

```{r}
# MCEM -----------------------------
#source("MCEM_with_output.R")
SSMod2 <- ssModel$newModel()

latentNodes <- SSMod2$getNodeNames(latentOnly=TRUE, stochOnly=TRUE)


box <- list(list(c('sigPN', 'sigOE'), c(1e-04, 100)),list(c("rho"),c(-0.9999, 0.9999)),list(c("x0"),c(-Inf,Inf)))
SSModMCEM <- buildMCEM(model=SSMod2, latentNodes=latentNodes,
                      boxConstraints=box) 

#Error in buildMCEM(model = SSMod2, latentNodes = latentNodes, boxConstraints = box) : 
#  latentNodes provided not found in model

ptm <- proc.time()
resultsSSModMCEM <- SSModMCEM$run(initM = 1000)
timeSSModMCEM <- proc.time() - ptm
timeSSModMCEM  ## 358.430 
# Iteration Number: 32.
# Current number of MCMC iterations: 9046.
# Parameter Estimates: 
#         rho          mu       sigPN       sigOE 
#    0.999899 1107.885603    4.597082    6.301182 
# Convergence Criterion: 0.000284768.

# Save outputs ------------------------
save(resultsSSModMCEM, file="MCEM_SSMod.RData")
```

```{r}
timeInfo <- cbind(c(timeSSModFixed, timeSSModSmallFixed,
                    timeSSModAdadelta, timeSSModAdam,
                    timeSSModNR, timeSSMod1D, timeSSModMCEM),
                  c("fixed", "smallFixed", "adadelta", "adam",
                    "NR", "1D", "mcem"))

write.csv(timeInfo, "timeSSMod.csv", row.names=F)

```